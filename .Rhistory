rv.ville %>% filter(quantile == "q2") %>%
ggplot(aes(x = annee, y = contrib, group = nom))
rv.ville %>% filter(quantile == "q2") %>%
ggplot(aes(x = annee, y = contrib, group = nom)) +
geom_line()
rv.ville %>% filter(quantile == "q2") %>%
ggplot(aes(x = annee, y = revenu, group = nom)) +
geom_line()
rv.ville %>% filter(quantile == "q2") %>%
ggplot(aes(x = annee, y = revenu, group = nom)) +
geom_line() +
theme_tam()
rv.ville %>% filter(quantile == "q2") %>%
ggplot(aes(x = annee, y = revenu, group = nom)) +
geom_line() +
theme_tam()
rv.ville %>% filter(quantile == "q2") %>%
ggplot(aes(x = annee, y = revenu, group = nom)) +
geom_line() +
theme_tam()
# Chunk 1: setup
revenus_commune <- "data/T_20_02_3_21.xlsx"
revenues_ville <- "data/T_20_02_3_22.xlsx"
cleanOutput <- F
downloadWaterGE <- F
require(lintr)
library(tidyverse)
library(magrittr)
library(stringr)
library(knitr)
library(tamMap)
library(tamTheme)
library(sf)
library(hrbrthemes)
### Interactive
library(ggiraph)
library(htmltools)
#library(swiRcharts)
library(classInt)
# Chunk 2: load revenus
revenus <- readxl::read_excel(revenus_commune, range = "A20:Q64", col_names = F) %>%
select(-X__4, -X__6, -X__11, -X__13)
names(revenus) <- c('nom', 'effectif_abs', 'effectif_pc',
'marie_nb', 'marie_q1', 'marie_q2', 'marie_q3', 'marie_q3q1',
'celib_nb', 'celib_q1', 'celib_q2', 'celib_q3', 'celib_q3q1')
revenus %<>% select(-effectif_abs, -effectif_pc, -marie_q3q1, -celib_q3q1)
# make it long
longify <- function(df, groupName = "marie") {
dfsub <- df %>%
select(nom, starts_with(groupName))
colnames(dfsub) <- c('nom', 'n', 'q1', 'q2', 'q3')
dfsub %<>%
gather("quantile", "revenu", -nom, -n) %>%
mutate(contrib = groupName)
dfsub
}
rvn <- bind_rows(longify(revenus, "marie"), longify(revenus, "celib"))
## GE ville
rville <- readxl::read_excel(revenues_ville, range = "A20:Q39", col_names = F) %>%
select(-X__4, -X__6, -X__10, -X__11, -X__13, -X__17)
names(rville) <- c('nom', 'effectif_abs', 'effectif_pc',
'marie_nb', 'marie_q1', 'marie_q2', 'marie_q3',
'celib_nb', 'celib_q1', 'celib_q2', 'celib_q3')
rville %<>% select(-effectif_abs, -effectif_pc) %>%
filter(!nom %in% c('Genève-Cité', 'Plainpalais', 'Eaux-Vives', 'Petit-Saconnex')) %>%
mutate(nom = str_replace(nom, "Cité\\-Centre", "Cité \\- Centre")) %>%
mutate(nom = str_replace(nom, "^La ", "")) %>%
mutate(nom = str_replace(nom, "St\\-Jean \\- Aïre", "St-Jean - Aire"))
rvr <- bind_rows(longify(rville, "marie"), longify(rville, "celib"))
rville2 <- readxl::read_excel(revenues_ville, sheet = "2011",
range = "A20:Q39", col_names = F) %>%
select(-X__2, -X__5, -X__7, -X__11, -X__12, -X__14)
names(rville2) <- c('nom', 'effectif_abs', 'effectif_pc',
'marie_nb', 'marie_q1', 'marie_q2', 'marie_q3',
'celib_nb', 'celib_q1', 'celib_q2', 'celib_q3')
rville2 %<>% select(-effectif_abs, -effectif_pc) %>%
filter(!nom %in% c('Genève-Cité', 'Plainpalais', 'Eaux-Vives', 'Petit-Saconnex')) %>%
mutate(nom = str_replace(nom, "Cité\\-Centre", "Cité \\- Centre")) %>%
mutate(nom = str_replace(nom, "^La ", "")) %>%
mutate(nom = str_replace(nom, "St\\-Jean \\- Aïre", "St-Jean - Aire"))
rv.ville <- bind_rows(
longify(rville, "marie") %>% mutate(annee = 2014),
longify(rville2, "marie") %>% mutate(annee = 2011)
)
rv.ville %>% filter(quantile == "q2") %>%
ggplot(aes(x = annee, y = revenu, group = nom)) +
geom_line() +
theme_tam()
rv.ville
rv.ville %>% arrange(annee) %>%
group_by (nom, quantile) %>%
summarise(diff = (revenu[2] - revenu[1]) / revenu[1])
rv.ville %>% arrange(annee) %>%
group_by (nom, quantile) %>%
summarise(diff = ((revenu[2] - revenu[1]) / revenu[1]) * 100) %>%
ungroup()
rv.ville %>% arrange(annee) %>%
group_by (nom, quantile) %>%
summarise(diff = ((revenu[2] - revenu[1]) / revenu[1]) * 100) %>%
ungroup() %>%
arrange(diff)
rv.ville %>% arrange(annee) %>%
group_by (nom, quantile) %>%
summarise(diff = ((revenu[2] - revenu[1]) / revenu[1]) * 100) %>%
ungroup() %>%
arrange(diff) %>% filter(quantile == "q2")
rv.ville %>% filter(quantile == "q2") %>%
ggplot(aes(x = annee, y = revenu, group = nom)) +
geom_line() +
theme_tam()rv.ville
rv.ville
rv.ville %>% filter(quantile %in% c("q1", "q3")) %>%
group_by(name, annee) %>%
mutate(q3q1 = q3/q1)
rv.ville %>% filter(quantile %in% c("q1", "q3")) %>%
group_by(nom, annee) %>%
mutate(q3q1 = q3/q1) %>%
ungroup()
rv.ville %>% filter(quantile %in% c("q1", "q3")) %>%
arrange(quantile)
group_by(nom, annee) %>%
mutate(q3q1 = revenu[2] / revenu[1]) %>%
ungroup()
rv.ville %>% filter(quantile %in% c("q1", "q3")) %>%
arrange(quantile) %>%
group_by(nom, annee) %>%
mutate(q3q1 = revenu[2] / revenu[1]) %>%
ungroup()
rv.ville %>% filter(quantile %in% c("q1", "q3")) %>%
arrange(quantile) %>%
group_by(nom, annee) %>%
sumarise(q3q1 = revenu[2] / revenu[1]) %>%
ungroup()
rv.ville %>% filter(quantile %in% c("q1", "q3")) %>%
arrange(quantile) %>%
group_by(nom, annee) %>%
summarise(q3q1 = revenu[2] / revenu[1]) %>%
ungroup()
rv.q3q1 <- rv.ville %>% filter(quantile %in% c("q1", "q3")) %>%
arrange(quantile) %>%
group_by(nom, annee) %>%
summarise(q3q1 = revenu[2] / revenu[1]) %>%
ungroup()
rv.q3q1 %>%
ggplot(aes(x = annee, y = q3q1, group = nom)) +
geom_line() +
theme_tam()
rv.q3q1 %>%
ggplot(aes(x = annee, y = q3q1, group = nom)) +
geom_line() +
theme_tam()
rv.q3q1 <- rv.ville %>% filter(quantile %in% c("q1", "q3")) %>%
arrange(quantile) %>%
group_by(nom, annee) %>%
summarise(q3q1 = revenu[2] / revenu[1]) %>%
ungroup() %>%
arrange(desc(q3q1))
rv.q3q1
rv.q3q1 %>% spread()
rv.q3q1 %>% spread(-nom)
rv.q3q1 %>% spread(name, value)
rv.q3q1 %>% spread(annee)
rv.q3q1 %>% spread(-nom)
?spread
rv.q3q1 %>% spread(annee, q3q1)
rv.q3q1 %>% spread(annee, q3q1) %>% mutate(diff = `2014` - `2011`)
rv.q3q1 %>% spread(annee, q3q1) %>%
mutate(diff = `2014` - `2011`) %>%
arrage(desc(diff))
rv.q3q1 %>% spread(annee, q3q1) %>%
mutate(diff = `2014` - `2011`) %>%
arrange(desc(diff))
rv.ville %>% filter(quantile == "q3") %>%
ggplot(aes(x = annee, y = revenu, group = nom)) +
geom_line() +
theme_tam()
rv.ville
rv.villerv.q3q1 %>%
ggplot(aes(x = annee, y = q3q1, group = nom)) +
geom_line() +
theme_tam()
rv.q3q1 %>%
ggplot(aes(x = annee, y = q3q1, group = nom)) +
geom_line() +
theme_tam()
rv.q3q1 %>%
ggplot(aes(x = annee, y = q3q1, group = nom, colour = nom)) +
geom_line() +
theme_tam()
rv.q3q1 %>% spread(annee, q3q1) %>%
mutate(diff = `2014` - `2011`) %>%
arrange(desc(diff))
rv.ville %>% filter(quantile == "q2") %>%
ggplot(aes(x = annee, y = revenu, group = nom)) +
geom_line() +
theme_tam()
revenus_xls <- "data/T_20_02_3_23.xls"
cleanOutput <- F
downloadWaterGE <- F
require(lintr)
library(tidyverse)
library(magrittr)
library(stringr)
library(knitr)
library(tamMap)
library(tamTheme)
library(sf)
library(hrbrthemes)
### Interactive
library(ggiraph)
library(htmltools)
#library(swiRcharts)
library(classInt)
readxl::read_excel(revenus_xls, range = "A14:G489", col_names = F)
revenus <- readxl::read_excel(revenus_xls, range = "A14:G489", col_names = F) %>%
select(-X__3, -X__4, -X__5, -X__7)
revenus
revenus <- readxl::read_excel(revenus_xls, range = "A14:G489", col_names = F) %>%
select(-X__3, -X__4, -X__5, -X__7)
colnames(revenus) <- c('commune', 'soussecteur', 'revenu')
revenus
X__6
revenus <- readxl::read_excel(revenus_xls, range = "A14:G489", col_names = F) %>%
select(-X__3, -X__4, -X__5, -X__7) %>%
mutate(X__6 = as.numeric(X__6))
colnames(revenus) <- c('commune', 'soussecteur', 'revenu')
revenus
shp_path(dirGeo = "CH/ge")
shp_path(dirGeo = "CH/ge")
shp_path(dirGeo = "CH/")
setwd("~/tg/2018_07_18_revenusFortune_GE")
# Chunk 1: setup
revenus_xls <- "data/T_20_02_3_23.xls"
cleanOutput <- F
downloadWaterGE <- F
require(lintr)
library(tidyverse)
library(magrittr)
library(stringr)
library(knitr)
library(tamMap)
library(tamTheme)
library(sf)
library(hrbrthemes)
### Interactive
library(ggiraph)
library(htmltools)
#library(swiRcharts)
library(classInt)
revenus <- readxl::read_excel(revenus_xls, range = "A14:G489", col_names = F) %>%
select(-X__3, -X__4, -X__5, -X__7) %>%
mutate(X__6 = as.numeric(X__6))
colnames(revenus) <- c('commune', 'soussecteur', 'revenu')
shp_path(dirGeo = "CH/ge")
setwd("~/tg/2018_07_18_revenusFortune_GE")
# Chunk 1: setup
revenus_xls <- "data/T_20_02_3_23.xls"
cleanOutput <- F
downloadWaterGE <- F
require(lintr)
library(tidyverse)
library(magrittr)
library(stringr)
library(knitr)
library(tamMap)
library(tamTheme)
library(sf)
library(hrbrthemes)
### Interactive
library(ggiraph)
library(htmltools)
#library(swiRcharts)
library(classInt)
revenus <- readxl::read_excel(revenus_xls, range = "A14:G489", col_names = F) %>%
select(-X__3, -X__4, -X__5, -X__7) %>%
mutate(X__6 = as.numeric(X__6))
colnames(revenus) <- c('commune', 'soussecteur', 'revenu')
shp_path(dirGeo = "CH/ge")
shp.path <- shp_path(dirGeo = "CH/ge")
st_layers(shp.path)
shp.path <- shp_path(dirGeo = "CH/ge")
st_read(shp.path, layer = "GEO_GIREC")
geo.ge <- st_read(shp.path, layer = "GEO_GIREC")
str(geo.ge)
head(geo.ge)
revenus
geo.ge
match(revenus$soussecteur, geo.ge$NOM)
geo.ge
str(revenus)
str(revenus)shp.path <- shp_path(dirGeo = "CH/ge")
geo.ge <- st_read(shp.path, layer = "GEO_GIREC") %>%
mutate(nom = gsub(" \\- ", "-", NOM))
shp.path <- shp_path(dirGeo = "CH/ge")
geo.ge <- st_read(shp.path, layer = "GEO_GIREC") %>%
mutate(nom = gsub(" \\- ", "-", NOM))
head(shp.path <- shp_path(dirGeo = "CH/ge")
geo.ge <- st_read(shp.path, layer = "GEO_GIREC") %>%
mutate(nom = gsub(" \\- ", "-", NOM)))
head(geo.ge)
match(revenus$soussecteur, geo.ge$NOM)
match(revenus$soussecteur, geo.ge$nom)
match(revenus$soussecteur, geo.ge$nom)
is.na(match(revenus$soussecteur, geo.ge$nom)) %>% sum()
is.na(match(revenus$soussecteur, geo.ge$NOM))
is.na(match(revenus$soussecteur, geo.ge$NOM)) %>% sum()
is.na(match(revenus$soussecteur, geo.ge$nom)) %>% sum()
idx <- match(revenus$soussecteur, geo.ge$nom)
idx
idx %>% is.na() %>% sum()
revenus$soussecteur[is.na(idx)]
idx
is.na(idx)
revenus$soussecteur[is.na(idx)]
revenus$soussecteur[is.na(idx)]
revenus <- readxl::read_excel(
revenus_xls, sheet = "2014", range = "A14:G489", col_names = F) %>%
select(-X__3, -X__4, -X__5, -X__7) %>%
mutate(X__6 = as.numeric(X__6))
colnames(revenus) <- c('commune', 'soussecteur', 'revenu')
shp.path <- shp_path(dirGeo = "CH/ge")
geo.ge <- st_read(shp.path, layer = "GEO_GIREC") %>%
mutate(nom = gsub(" \\- ", "-", NOM))
match(revenus$soussecteur, geo.ge$NOM)
idx <- match(revenus$soussecteur, geo.ge$nom)
match(revenus$soussecteur, geo.ge$nom)
idx %>% is.na() %>% sum()
revenus$soussecteur[is.na(idx)]
geo.ge$nom
match(geo.ge$nom, revenus$soussecteur)
match(geo.ge$nom, revenus$soussecteur) %>% is.na() %>% sum()
geo.ge$nom
idx <- match(geo.ge$nom, revenus$soussecteur)
idx %>% is.na() %>% sum()
geo.ge$nom[is.na(idx)]
Saint-Mathieu-stand
revenus$soussecteur
revenus$soussecteur
revenus
revenus
geo.ge
geo.ge %>% filter(nom == "Treulaz")
geo.ge %>% filter(nom == "Cheveniez")
geo.ge %>% filter(nom == "Cheneviez")
geo.ge %>% filter(nom == "Cheneviers")
revenus
idx <- match(geo.ge$nom, revenus$soussecteur)
idx %>% is.na() %>% sum()
geo.ge$nom[is.na(idx)]
match("Aéroport-tour-de-contrôle", revenus$soussecteur)
match("Aéroport-tour-de-contrôle", revenus$soussecteur)
match("Aéroport", revenus$soussecteur)
grep("Aéroport", revenus$soussecteur)
revenus$soussecteur[grep("Aéroport", revenus$soussecteur)]
grep("Saint-Mathieu", revenus$soussecteur)
revenus$soussecteur[grep("Saint-Mathieu", revenus$soussecteur)]
idx <- match(tolower(geo.ge$nom), tolower(revenus$soussecteur))
idx %>% is.na() %>% sum()
geo.ge$nom[is.na(idx)]
which(revenus$soussecteur == "La Petite-Boissière")
idx <- match(tolower(geo.ge$nom), tolower(revenus$soussecteur))
idx %>% is.na() %>% sum()
geo.ge$nom[is.na(idx)]
which(revenus$soussecteur == "La Petite-Boisière")
revenus$soussecteur[is.na(idx)]
shp.path <- shp_path(dirGeo = "CH/ge")
geo.ge <- st_read(shp.path, layer = "GEO_GIREC") %>%
mutate(nom = gsub(" \\- ", "-", NOM))
match(revenus$soussecteur, geo.ge$NOM)
idx <- match(revenus$soussecteur, geo.ge$nom)
idx %>% is.na() %>% sum()
revenus$soussecteur[is.na(idx)]
idx <- match(tolower(geo.ge$nom), tolower(revenus$soussecteur))
idx %>% is.na() %>% sum()
geo.ge$nom[is.na(idx)]
revenus[which(revenus$soussecteur == "Communaux-d'Ambily"), 'soussecteur']
revenus[which(revenus$soussecteur == "Les Crêts-de-Champel"), 'soussecteur']
revenus[which(revenus$soussecteur == "La Petite-Boisière"), 'soussecteur'] <- "La Petite-Boissière"
revenus[which(revenus$soussecteur == "Communaux-d'Ambily"), 'soussecteur'] <- "Communaux-d'Ambilly"
revenus[which(revenus$soussecteur == "Les Crêts-de-Champel"), 'soussecteur'] <- "Les Crêts-de-Champel 1"
revenus[which(revenus$soussecteur == "Crêts-de-Champel"), 'soussecteur'] <- "Les Crêts-de-Champel 2"
idx <- match(tolower(geo.ge$nom), tolower(revenus$soussecteur))
idx %>% is.na() %>% sum()
geo.ge$nom[is.na(idx)]
geo.ge
geo.ge %>% filter(nom == "Les Crêts-de-Champel 1")
geo.ge %>% filter(nom == "Les Crêts-de-Champel 2")
idx
idx <- match(tolower(geo.ge$nom.m), tolower(revenus$nom.m))
revenus <- readxl::read_excel(
revenus_xls, sheet = "2014", range = "A14:G489", col_names = F) %>%
select(-X__3, -X__4, -X__5, -X__7) %>%
mutate(X__6 = as.numeric(X__6))
colnames(revenus) <- c('commune', 'soussecteur', 'revenu')
shp.path <- shp_path(dirGeo = "CH/ge")
geo.ge <- st_read(shp.path, layer = "GEO_GIREC") %>%
mutate(nom = gsub(" \\- ", "-", NOM))
match(revenus$soussecteur, geo.ge$NOM)
idx <- match(revenus$soussecteur, geo.ge$nom)
idx %>% is.na() %>% sum()
revenus$soussecteur[is.na(idx)]
# hack rename: Les Crêts-de-Champel?!
revenus[which(revenus$soussecteur == "La Petite-Boisière"), 'soussecteur'] <- "La Petite-Boissière"
revenus[which(revenus$soussecteur == "Communaux-d'Ambily"), 'soussecteur'] <- "Communaux-d'Ambilly"
revenus[which(revenus$soussecteur == "Les Crêts-de-Champel"), 'soussecteur'] <- "Les Crêts-de-Champel 1"
revenus[which(revenus$soussecteur == "Crêts-de-Champel"), 'soussecteur'] <- "Les Crêts-de-Champel 2"
geo.ge %<>%
mutate(nom.m = tolower(nom))
revenus %<>%
mutate(nom.m = tolower(soussecteur))
idx <- match(tolower(geo.ge$nom.m), tolower(revenus$nom.m))
idx
idx %>% is.na() %>% sum()
stopifnot(idx %>% is.na() %>% sum() == 0)
left_join(geo.ge, revenus)
revenus <- readxl::read_excel(
revenus_xls, sheet = "2014", range = "A14:G489", col_names = F) %>%
select(-X__3, -X__4, -X__5, -X__7) %>%
mutate(X__6 = as.numeric(X__6))
colnames(revenus) <- c('commune', 'soussecteur', 'revenu')
shp.path <- shp_path(dirGeo = "CH/ge")
geo.ge <- st_read(shp.path, layer = "GEO_GIREC") %>%
mutate(nom = gsub(" \\- ", "-", NOM))
match(revenus$soussecteur, geo.ge$NOM)
idx <- match(revenus$soussecteur, geo.ge$nom)
idx %>% is.na() %>% sum()
revenus$soussecteur[is.na(idx)]
# hack rename: Les Crêts-de-Champel?!
revenus[which(revenus$soussecteur == "La Petite-Boisière"), 'soussecteur'] <- "La Petite-Boissière"
revenus[which(revenus$soussecteur == "Communaux-d'Ambily"), 'soussecteur'] <- "Communaux-d'Ambilly"
revenus[which(revenus$soussecteur == "Les Crêts-de-Champel"), 'soussecteur'] <- "Les Crêts-de-Champel 1"
revenus[which(revenus$soussecteur == "Crêts-de-Champel"), 'soussecteur'] <- "Les Crêts-de-Champel 2"
geo.ge %<>%
mutate(nom.m = tolower(nom))
revenus %<>%
mutate(nom.m = tolower(soussecteur))
idx <- match(tolower(geo.ge$nom.m), tolower(revenus$nom.m))
stopifnot(idx %>% is.na() %>% sum() == 0)
revenus.geo <- left_join(geo.ge, revenus) %>%
select(-nom.m, -soussecteur)
revenus.geo
# Chunk 1: setup
revenus_xls <- "data/T_20_02_3_23.xls"
cleanOutput <- F
downloadWaterGE <- F
require(lintr)
library(tidyverse)
library(magrittr)
library(stringr)
library(knitr)
library(tamMap)
library(tamTheme)
library(sf)
library(hrbrthemes)
### Interactive
library(ggiraph)
library(htmltools)
library(classInt)
# Chunk 2: load revenus and the map
revenus <- readxl::read_excel(
revenus_xls, sheet = "2014", range = "A14:G489", col_names = F) %>%
select(-X__3, -X__4, -X__5, -X__7) %>%
mutate(X__6 = as.numeric(X__6))
colnames(revenus) <- c('commune', 'soussecteur', 'revenu')
shp.path <- shp_path(dirGeo = "CH/ge")
geo.ge <- st_read(shp.path, layer = "GEO_GIREC") %>%
mutate(nom = gsub(" \\- ", "-", NOM))
match(revenus$soussecteur, geo.ge$NOM)
idx <- match(revenus$soussecteur, geo.ge$nom)
idx %>% is.na() %>% sum()
revenus$soussecteur[is.na(idx)]
# hack rename: Les Crêts-de-Champel?!
revenus[which(revenus$soussecteur == "La Petite-Boisière"), 'soussecteur'] <- "La Petite-Boissière"
revenus[which(revenus$soussecteur == "Communaux-d'Ambily"), 'soussecteur'] <- "Communaux-d'Ambilly"
revenus[which(revenus$soussecteur == "Les Crêts-de-Champel"), 'soussecteur'] <- "Les Crêts-de-Champel 1"
revenus[which(revenus$soussecteur == "Crêts-de-Champel"), 'soussecteur'] <-
"Les Crêts-de-Champel 2"
geo.ge %<>%
mutate(nom.m = tolower(nom))
revenus %<>%
mutate(nom.m = tolower(soussecteur))
idx <- match(tolower(geo.ge$nom.m), tolower(revenus$nom.m))
stopifnot(idx %>% is.na() %>% sum() == 0)
revenus.geo <- left_join(geo.ge, revenus) %>%
select(-nom.m, -soussecteur)
if(downloadWaterGE) {
library(esri2sf)
url <- 'https://ge.ch/sitgags1/rest/services/VECTOR/SITG_OPENDATA_02/MapServer/6186'
water <- esri2sf(url)
water <- st_transform(water, st_crs(muni))
water %>% st_write(dsn = "data/", driver = "ESRI Shapefile", layer = "waterGE.shp")
} else {
water <- st_read("data/waterGE.shp", layer = "waterGE")
}
revenus.geo %>% ggplot() +
geom_sf(
aes(fill = revenu), lwd = 0.05)
revenus.geo %>% ggplot() +
geom_sf(aes(fill = revenu), lwd = 0.05) +
geom_sf(
data = water, lwd = 0.9, fill = watercol, alpha = 1
)
revenus.geo %>% ggplot() +
geom_sf(aes(fill = revenu), lwd = 0.05) +
geom_sf(
data = water, alpha = 1
)
revenus.geo %>% ggplot() +
geom_sf(aes(fill = revenu), lwd = 0.05) +
geom_sf(
data = water, alpha = 1, lwd = 0.5, fill = "white", stroke = "white"
)
